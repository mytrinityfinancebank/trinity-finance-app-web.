<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Trinity Finance Bank Dashboard</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap');
        body { font-family: 'Inter', sans-serif; background-color: #f7fafc; }
        .card { background-color: white; border-radius: 12px; box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -2px rgba(0, 0, 0, 0.1); }
        .gradient-card { 
            background: linear-gradient(135deg, #1f2937 0%, #4b5563 100%);
            color: white;
            position: relative;
            overflow: hidden;
        }
        .gradient-card::before {
            content: '';
            position: absolute;
            top: -50%;
            left: -50%;
            width: 200%;
            height: 200%;
            background: rgba(255, 255, 255, 0.05);
            transform: rotate(45deg);
        }
        .btn-primary { background-color: #2563eb; color: white; transition: background-color 0.2s; }
        .btn-primary:hover:not(:disabled) { background-color: #1d4ed8; }
        button:disabled { cursor: not-allowed; opacity: 0.6; }
        .nav-link { cursor: pointer; padding: 0.5rem 0.25rem; margin: 0 0.5rem; transition: all 0.15s ease-in-out; }
        .nav-link:hover { color: #2563eb; }
        input[type="number"]::-webkit-outer-spin-button, input[type="number"]::-webkit-inner-spin-button { -webkit-appearance: none; margin: 0; }
        .modal-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background-color: rgba(0, 0, 0, 0.6); display: flex; align-items: center; justify-content: center; z-index: 60; }
        .modal-content { background: white; border-radius: 12px; box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -4px rgba(0, 0, 0, 0.1); width: 90%; max-width: 400px; padding: 1.5rem; }
    </style>
</head>
<body class="p-4 sm:p-8">

    <script type="module">
        // Using a stable Firebase version (10.8.0) to prevent version errors
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-app.js";
        import { getAuth, signInAnonymously, signInWithCustomToken } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-auth.js";
        import { getFirestore, doc, getDoc, setDoc, onSnapshot, updateDoc, arrayUnion, runTransaction, setLogLevel } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-firestore.js";

        // --- DATA CONFIGURATION (2016 Dates) ---
        const ACCOUNT_HOLDER_NAME = "Steven Arney";
        const INITIAL_BALANCE = 71800000.00; 
        const SIMULATED_OTP = "123456";
        
        // Explicit 2016 History Data (June - Oct)
        const SEEDED_HISTORY = [
            { refId: 'TRXD96E73C7', type: 'Debit', amount: 450.00, timestamp: new Date('2016-06-12T10:30:00'), runningBalance: 71799550.00, source: 'Online Payment - Utility' }, 
            { refId: 'TRXCA9F71F16', type: 'Credit', amount: 1200.00, timestamp: new Date('2016-06-28T14:15:00'), runningBalance: 71800750.00, source: 'Salary Deposit' }, 
            { refId: 'TRXD093AEE8D', type: 'Debit', amount: 250.00, timestamp: new Date('2016-07-05T09:00:00'), runningBalance: 71800500.00, source: 'Rent Payment' }, 
            { refId: 'TRXC8FE0A45D', type: 'Credit', amount: 50.00, timestamp: new Date('2016-07-20T16:45:00'), runningBalance: 71800550.00, source: 'Refund - Online Store' }, 
            { refId: 'TRXD749FFDD2', type: 'Debit', amount: 150.00, timestamp: new Date('2016-08-15T11:20:00'), runningBalance: 71800400.00, source: 'Grocery Store' }, 
            { refId: 'TRXC9DE8249B', type: 'Credit', amount: 500.00, timestamp: new Date('2016-08-30T13:00:00'), runningBalance: 71800900.00, source: 'Investment Payout' }, 
            { refId: 'TRXDAD68D66D', type: 'Debit', amount: 50.00, timestamp: new Date('2016-09-10T08:30:00'), runningBalance: 71800850.00, source: 'Coffee Shop' }, 
            { refId: 'TRXCC5B2F62F', type: 'Credit', amount: 200.00, timestamp: new Date('2016-10-05T15:10:00'), runningBalance: 71801050.00, source: 'Freelance Income' }, 
            { refId: 'TRXCC5B2162F', type: 'Credit', amount: -1050.00, timestamp: new Date('2016-10-25T12:00:00'), runningBalance: 71800000.00, source: 'Initial Seed Adjustment' },
        ];

        // --- GLOBAL VARS ---
        const firebaseConfig = typeof __firebase_config !== 'undefined' ? JSON.parse(__firebase_config) : {
            apiKey: "AIzaSyACOITBYfN3Y1G1-QTWgo_t1PutVlsLYKI",
            authDomain: "trinity-finance-app-6002.firebaseapp.com",
            projectId: "trinity-finance-app-6002",
            storageBucket: "trinity-finance-app-6002.firebasestorage.app",
            messagingSenderId: "545859635678",
            appId: "1:545859635678:web:6b13c3da6c61a23b23354f",
            measurementId: "G-NLWB0495RW"
        };
        
        let db, auth, userId, accountRef;
        let currentBalance = INITIAL_BALANCE;
        let transactionHistory = [];
        let pendingTransfer = null;
        let isOfflineMode = false;

        // --- DOM ELEMENTS ---
        const balanceEl = document.getElementById('balance');
        const dashboardHistoryBody = document.getElementById('dashboard-history-body');
        const fullHistoryTableBody = document.getElementById('full-history-table-body');
        const totalTransactionsEl = document.getElementById('total-transactions');
        const messageBox = document.getElementById('message-box');
        const messageText = document.getElementById('message-text');
        const loginContainer = document.getElementById('login-container');
        const mainContent = document.getElementById('main-content');
        const accountUserIdEl = document.getElementById('account-user-id');
        const accountHolderEl = document.getElementById('account-holder-name');
        const otpModal = document.getElementById('otp-modal');
        const otpInput = document.getElementById('otp-input');
        const transferSubmitBtn = document.getElementById('transfer-submit-btn');

        // --- UTILS ---
        function showMessage(msg, type = 'success') {
            messageText.textContent = msg;
            messageBox.className = `fixed top-4 right-4 p-4 rounded-lg z-50 transition-transform transform ${type === 'success' ? 'bg-green-100 text-green-800' : 'bg-red-100 text-red-800'} shadow-lg translate-x-0`;
            setTimeout(() => { messageBox.className = `fixed top-4 right-4 p-4 rounded-lg z-50 transition-transform transform translate-x-full`; }, 3000);
        }
        const formatCurrency = (amount) => new Intl.NumberFormat('en-US', { style: 'currency', currency: 'USD', minimumFractionDigits: 2 }).format(amount);
        const generateRefId = (type) => (type === 'Debit' ? 'TRXD' : 'TRXC') + Math.random().toString(16).substring(2, 10).toUpperCase();

        // --- NAVIGATION ---
        window.navigateTo = function(pageId) {
            document.querySelectorAll('.app-page').forEach(page => page.classList.add('hidden'));
            document.getElementById(pageId).classList.remove('hidden');
            document.querySelectorAll('.nav-link').forEach(link => {
                link.classList.remove('text-blue-600', 'font-bold', 'border-b-2', 'border-blue-600');
                link.classList.add('text-gray-500');
            });
            const activeLink = document.getElementById(`nav-${pageId}`);
            if (activeLink) {
                activeLink.classList.add('text-blue-600', 'font-bold', 'border-b-2', 'border-blue-600');
                activeLink.classList.remove('text-gray-500');
            }
            if (pageId === 'history-content') renderFullHistory();
        }

        // --- RENDERING ---
        function renderHistoryTable(tableBody, history, limit = null) {
            tableBody.innerHTML = '';
            // Sort oldest to newest by Date
            const sortedHistory = [...history].sort((a, b) => {
                const dateA = a.timestamp instanceof Date ? a.timestamp : (a.timestamp.toDate ? a.timestamp.toDate() : new Date(a.timestamp));
                const dateB = b.timestamp instanceof Date ? b.timestamp : (b.timestamp.toDate ? b.timestamp.toDate() : new Date(b.timestamp));
                return dateA - dateB;
            });

            let displayList = sortedHistory;
            if (limit) {
                // For dashboard (recent first), we reverse and slice
                displayList = sortedHistory.slice().reverse().slice(0, limit);
            } else {
                // For full history, we keep oldest-to-newest, but the UI renders top-down.
                // Actually, standard bank statements often show newest at top. 
                // But requirement was "Last Month to Recent". We will reverse it so Recent is at top.
                displayList = sortedHistory.slice().reverse();
            }

            displayList.forEach((tx, index) => {
                const row = tableBody.insertRow(-1);
                row.className = index % 2 === 0 ? 'bg-white' : 'bg-gray-50';
                
                let displayDate = 'N/A';
                const dateObj = tx.timestamp instanceof Date ? tx.timestamp : (tx.timestamp.toDate ? tx.timestamp.toDate() : new Date(tx.timestamp));
                displayDate = dateObj.toLocaleDateString();

                row.insertCell().textContent = limit ? (index + 1) : (sortedHistory.length - index); // Index logic
                const cellRef = row.insertCell(); cellRef.textContent = tx.refId; cellRef.className = 'font-mono text-xs text-gray-700 py-2 px-4';
                row.insertCell().textContent = tx.source || 'N/A';
                const cellAmount = row.insertCell(); cellAmount.textContent = formatCurrency(tx.amount); cellAmount.className = `font-semibold py-2 px-4 ${tx.type === 'Credit' ? 'text-green-600' : 'text-red-600'}`;
                row.insertCell().textContent = tx.type;
                row.insertCell().textContent = displayDate;
                row.insertCell().textContent = formatCurrency(tx.runningBalance);
                
                Array.from(row.cells).forEach(c => c.classList.add('py-3', 'px-4', 'text-sm'));
            });
        }

        function renderDashboard() {
            balanceEl.textContent = formatCurrency(currentBalance);
            accountHolderEl.textContent = ACCOUNT_HOLDER_NAME;
            totalTransactionsEl.textContent = transactionHistory.length;
            renderHistoryTable(dashboardHistoryBody, transactionHistory, 10);
        }

        function renderFullHistory() {
            if (fullHistoryTableBody) renderHistoryTable(fullHistoryTableBody, transactionHistory, null);
        }

        // --- OFFLINE / DEMO MODE (FALLBACK) ---
        function startOfflineMode() {
            isOfflineMode = true;
            console.log("Starting Offline Mode...");
            currentBalance = INITIAL_BALANCE;
            transactionHistory = SEEDED_HISTORY;
            accountUserIdEl.textContent = "OFFLINE-DEMO-USER";
            
            loginContainer.classList.add('hidden');
            mainContent.classList.remove('hidden');
            renderDashboard();
            showMessage("Running in Demo Mode (2016 Data)", 'success');
        }

        // --- ONLINE INIT ---
        async function initializeAccount() {
            accountRef = doc(db, 'artifacts', appId, 'users', userId, 'accountData', 'main');
            try {
                const docSnap = await getDoc(accountRef);
                // Always force update to 2016 data for this session to fix the dates
                await setDoc(accountRef, {
                    accountHolder: ACCOUNT_HOLDER_NAME,
                    balance: INITIAL_BALANCE,
                    history: SEEDED_HISTORY,
                    lastUpdated: new Date()
                }, { merge: true });

                onSnapshot(accountRef, (doc) => {
                    if (doc.exists()) {
                        const data = doc.data();
                        currentBalance = data.balance;
                        transactionHistory = data.history || [];
                        renderDashboard();
                        if (!document.getElementById('history-content').classList.contains('hidden')) renderFullHistory();
                    }
                });
            } catch (error) {
                console.warn("Database write failed, switching to offline:", error);
                startOfflineMode();
            }
        }

        async function processTransaction(amount, type, source) {
            if (isOfflineMode) {
                // Offline logic
                if (type === 'Debit' && currentBalance < amount) {
                    showMessage("Insufficient funds.", 'error');
                    return false;
                }
                const newBal = type === 'Credit' ? currentBalance + amount : currentBalance - amount;
                const newTx = {
                    refId: generateRefId(type),
                    type: type, amount: amount,
                    timestamp: new Date(), // Current real time for new user actions
                    runningBalance: newBal, source: source
                };
                transactionHistory.push(newTx);
                currentBalance = newBal;
                renderDashboard();
                showMessage("Transaction Successful (Demo)", 'success');
                return true;
            }

            // Online logic
            try {
                await runTransaction(db, async (transaction) => {
                    const docSnap = await transaction.get(accountRef);
                    if (!docSnap.exists()) throw "Doc missing";
                    const data = docSnap.data();
                    let cb = data.balance;
                    if (type === 'Debit' && cb < amount) throw "Insufficient funds";
                    const nb = type === 'Credit' ? cb + amount : cb - amount;
                    const newTx = {
                        refId: generateRefId(type), type: type, amount: amount,
                        timestamp: new Date(), runningBalance: nb, source: source
                    };
                    transaction.update(accountRef, { balance: nb, history: arrayUnion(newTx) });
                });
                showMessage("Transaction Successful", 'success');
                return true;
            } catch (e) {
                showMessage(typeof e === 'string' ? e : "Transaction failed", 'error');
                return false;
            }
        }

        // --- EVENT HANDLERS ---
        window.showOtpModal = () => { otpInput.value = ''; otpModal.classList.remove('hidden'); };
        window.hideOtpModal = () => { otpModal.classList.add('hidden'); pendingTransfer = null; };
        
        window.handleOtpSubmission = async () => {
            const enteredOtp = otpInput.value.trim();
            if (enteredOtp !== SIMULATED_OTP) { showMessage("Invalid OTP.", 'error'); return; }
            window.hideOtpModal();
            const { amount, source } = pendingTransfer;
            const success = await processTransaction(amount, 'Debit', source);
            if (success) {
                document.getElementById('transfer-bank-name').value = '';
                document.getElementById('transfer-account-number').value = '';
                document.getElementById('transfer-amount').value = '';
                window.navigateTo('dashboard-content');
            }
        };

        window.handleBankTransfer = () => {
            const bank = document.getElementById('transfer-bank-name').value;
            const acct = document.getElementById('transfer-account-number').value;
            const amount = parseFloat(document.getElementById('transfer-amount').value);
            if (!bank || acct.length < 5 || !amount || amount <= 0) { showMessage("Invalid inputs", 'error'); return; }
            if (currentBalance < amount) { showMessage("Insufficient funds", 'error'); return; }
            pendingTransfer = { amount, source: `Bank Transfer to ${bank}` };
            window.showOtpModal();
        };

        async function initApp() {
            try {
                app = initializeApp(firebaseConfig);
                auth = getAuth(app);
                db = getFirestore(app);
                
                if (typeof __initial_auth_token !== 'undefined') await signInWithCustomToken(auth, __initial_auth_token);
                else await signInAnonymously(auth);
                
                userId = auth.currentUser.uid;
                accountUserIdEl.textContent = userId;
                loginContainer.classList.add('hidden');
                mainContent.classList.remove('hidden');
                await initializeAccount();
            } catch (error) {
                console.error("Init failed:", error);
                // FALLBACK TO OFFLINE MODE INSTEAD OF CRASHING
                startOfflineMode();
            }
        }

        window.onload = () => {
            initApp();
            document.getElementById('transfer-submit-btn').onclick = window.handleBankTransfer;
            document.getElementById('otp-submit-btn').onclick = window.handleOtpSubmission;
            document.getElementById('otp-cancel-btn').onclick = window.hideOtpModal;
            window.navigateTo('dashboard-content');
        };
    </script>

    <div id="message-box" class="fixed top-4 right-4 p-4 rounded-lg z-50 transition-transform transform translate-x-full"><p id="message-text" class="font-semibold"></p></div>
    
    <div id="login-container" class="flex items-center justify-center min-h-screen">
        <div class="card p-8 w-full max-w-sm text-center">
            <h1 class="text-3xl font-bold text-gray-800 mb-2">Trinity Finance Bank</h1>
            <p class="text-sm text-gray-500 mb-6">Loading secure environment...</p>
            <div class="animate-spin rounded-full h-8 w-8 border-b-2 border-blue-500 mx-auto mb-4"></div>
        </div>
    </div>

    <div id="main-content" class="hidden">
        <header class="mb-10 card p-4">
            <div class="flex flex-col md:flex-row justify-between items-center">
                <h1 class="text-3xl font-bold text-gray-800 mb-4 md:mb-0">Trinity Finance</h1>
                <nav class="flex space-x-2 md:space-x-4 text-lg">
                    <span id="nav-dashboard-content" class="nav-link text-blue-600 font-bold border-b-2 border-blue-600" onclick="navigateTo('dashboard-content')">Dashboard</span>
                    <span id="nav-transfer-content" class="nav-link" onclick="navigateTo('transfer-content')">Bank Transfer</span>
                    <span id="nav-history-content" class="nav-link" onclick="navigateTo('history-content')">History</span>
                </nav>
            </div>
        </header>

        <div id="dashboard-content" class="app-page">
            <p class="text-lg text-gray-600 mb-6">Overview</p>
            <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
                <div class="lg:col-span-1 space-y-6">
                    <div class="card p-6 bg-blue-600 text-white">
                        <p class="text-sm font-semibold opacity-80 mb-1">ACCOUNT BALANCE</p>
                        <h2 id="balance" class="text-4xl sm:text-5xl font-extrabold">$0.00</h2>
                    </div>
                    <div class="card p-6">
                        <h3 class="text-xl font-semibold text-gray-800 mb-4">Account Details</h3>
                        <div class="space-y-3 text-sm">
                            <p><span class="font-medium text-gray-500">Welcome:</span> <span id="account-holder-name" class="font-bold text-gray-900">Steven Arney</span></p>
                            <p><span class="font-medium text-gray-500">ACCOUNT TYPE:</span> <span class="font-semibold text-green-600">Fixed Deposit Account</span></p>
                            <p><span class="font-medium text-gray-500">ACCOUNT NUMBER:</span> <span class="font-mono text-gray-700">7739118821</span></p>
                            <p><span class="font-medium text-gray-500">TOTAL TRANSACTIONS:</span> <span id="total-transactions" class="font-bold text-gray-700">0</span></p>
                            <p><span class="font-medium text-gray-500">User ID:</span> <span id="account-user-id" class="font-mono text-xs text-blue-500 break-all">...</span></p>
                        </div>
                    </div>
                </div>
                <div class="lg:col-span-2 space-y-6">
                    <div class="gradient-card p-6 h-52 flex flex-col justify-between shadow-2xl">
                        <div><div class="text-xs font-light tracking-widest opacity-80 mb-2">Trinity Finance Virtual Card</div><div class="text-3xl font-mono tracking-widest">4815 1623 4277 7179</div></div>
                        <div class="flex justify-between items-center text-sm font-semibold">
                            <div><p class="text-xs font-light opacity-80">CARDHOLDER</p><p class="tracking-wider">STEVEN ARNEY</p></div>
                            <div class="flex space-x-6"><div><p class="text-xs font-light opacity-80">VALID THRU</p><p class="tracking-wider">12/28</p></div><div><p class="text-xs font-light opacity-80">CVV</p><p class="tracking-wider">823</p></div></div>
                        </div>
                    </div>
                </div>
            </div>
            <div class="mt-8 card p-6">
                <h3 class="text-2xl font-semibold text-gray-800 mb-4">Recent Transactions</h3>
                <div class="overflow-x-auto"><table class="min-w-full divide-y divide-gray-200"><thead class="bg-gray-100"><tr><th class="py-3 px-4 text-left text-xs font-medium text-gray-500 uppercase">#</th><th class="py-3 px-4 text-left text-xs font-medium text-gray-500 uppercase">Ref</th><th class="py-3 px-4 text-left text-xs font-medium text-gray-500 uppercase">Source</th><th class="py-3 px-4 text-left text-xs font-medium text-gray-500 uppercase">Amount</th><th class="py-3 px-4 text-left text-xs font-medium text-gray-500 uppercase">Type</th><th class="py-3 px-4 text-left text-xs font-medium text-gray-500 uppercase">Date</th><th class="py-3 px-4 text-left text-xs font-medium text-gray-500 uppercase">Balance</th></tr></thead><tbody id="dashboard-history-body" class="bg-white divide-y divide-gray-200"></tbody></table></div>
            </div>
        </div>

        <div id="transfer-content" class="app-page hidden">
            <h2 class="text-2xl font-bold text-gray-800 mb-6">Initiate Bank Transfer</h2>
            <div class="card p-8 max-w-lg mx-auto space-y-6">
                <div><label class="block text-sm font-medium text-gray-700 mb-1">Recipient Bank</label><input type="text" id="transfer-bank-name" class="w-full p-3 border border-gray-300 rounded-lg"></div>
                <div><label class="block text-sm font-medium text-gray-700 mb-1">Account Number</label><input type="text" id="transfer-account-number" class="w-full p-3 border border-gray-300 rounded-lg"></div>
                <div><label class="block text-sm font-medium text-gray-700 mb-1">Amount ($)</label><input type="number" id="transfer-amount" class="w-full p-3 border border-gray-300 rounded-lg"></div>
                <button id="transfer-submit-btn" class="w-full btn-primary font-bold py-3 rounded-lg">Confirm Transfer</button>
            </div>
        </div>

        <div id="history-content" class="app-page hidden">
            <h2 class="text-2xl font-bold text-gray-800 mb-6">Full History (2016)</h2>
            <div class="card p-6 overflow-x-auto"><table class="min-w-full divide-y divide-gray-200"><thead class="bg-gray-100"><tr><th class="py-3 px-4 text-left text-xs font-medium text-gray-500 uppercase">#</th><th class="py-3 px-4 text-left text-xs font-medium text-gray-500 uppercase">Ref</th><th class="py-3 px-4 text-left text-xs font-medium text-gray-500 uppercase">Source</th><th class="py-3 px-4 text-left text-xs font-medium text-gray-500 uppercase">Amount</th><th class="py-3 px-4 text-left text-xs font-medium text-gray-500 uppercase">Type</th><th class="py-3 px-4 text-left text-xs font-medium text-gray-500 uppercase">Date</th><th class="py-3 px-4 text-left text-xs font-medium text-gray-500 uppercase">Balance</th></tr></thead><tbody id="full-history-table-body" class="bg-white divide-y divide-gray-200"></tbody></table></div>
        </div>
    </div>

    <div id="otp-modal" class="modal-overlay hidden">
        <div class="modal-content text-center">
            <h3 class="text-xl font-bold text-gray-800 mb-4">Transfer Verification</h3>
            <p class="text-gray-600 mb-4">Enter 6-digit OTP</p>
            <input type="text" id="otp-input" class="w-full p-4 text-center text-2xl font-mono border-2 border-blue-300 rounded-lg mb-6">
            <div class="flex space-x-3"><button id="otp-cancel-btn" class="w-1/2 bg-gray-300 text-gray-800 font-bold py-3 rounded-lg">Cancel</button><button id="otp-submit-btn" class="w-1/2 btn-primary font-bold py-3 rounded-lg">Verify</button></div>
        </div>
    </div>

</body>
</html>
