<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Trinity Finance Bank Dashboard</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap');
        body { font-family: 'Inter', sans-serif; background-color: #f7fafc; }
        .card { background-color: white; border-radius: 12px; box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -2px rgba(0, 0, 0, 0.1); }
        .gradient-card { 
            background: linear-gradient(135deg, #1f2937 0%, #4b5563 100%);
            color: white;
            position: relative;
            overflow: hidden;
        }
        .gradient-card::before {
            content: '';
            position: absolute;
            top: -50%;
            left: -50%;
            width: 200%;
            height: 200%;
            background: rgba(255, 255, 255, 0.05);
            transform: rotate(45deg);
        }
        .btn-primary { background-color: #2563eb; color: white; transition: background-color 0.2s; }
        .btn-primary:hover:not(:disabled) { background-color: #1d4ed8; }
        .btn-success { background-color: #059669; color: white; transition: background-color 0.2s; }
        .btn-success:hover:not(:disabled) { background-color: #047857; }
        .btn-danger { background-color: #dc2626; color: white; transition: background-color 0.2s; }
        .btn-danger:hover:not(:disabled) { background-color: #b91c1c; }
        .btn-interest { background-color: #fbbf24; color: #1f2937; transition: background-color 0.2s; }
        .btn-interest:hover:not(:disabled) { background-color: #f59e0b; }
        button:disabled { cursor: not-allowed; opacity: 0.6; }

        input[type="number"]::-webkit-outer-spin-button,
        input[type="number"]::-webkit-inner-spin-button {
            -webkit-appearance: none;
            margin: 0;
        }
        input[type="number"] {
            -moz-appearance: textfield;
        }
    </style>
</head>
<body class="p-4 sm:p-8">

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, signInWithCustomToken } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        // Import runTransaction for better concurrency control (P2P logic below)
        import { getFirestore, doc, getDoc, setDoc, onSnapshot, updateDoc, arrayUnion, runTransaction } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // --- GLOBAL VARIABLES (Provided by Canvas Environment) ---
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'trinity-bank-app';
        const firebaseConfig = typeof __firebase_config !== 'undefined' ? JSON.parse(__firebase_config) : {
            apiKey: "DUMMY_API_KEY",
            authDomain: "DUMMY_AUTH_DOMAIN",
            projectId: "DUMMY_PROJECT_ID",
        };
        const initialAuthToken = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null;
        
        // --- APP STATE AND CONSTANTS ---
        const ACCOUNT_HOLDER_NAME = "Steven";
        const INITIAL_BALANCE = 71799032.65;
        const ACCOUNT_NUMBER = "7739118821";
        const ROUTING_NUMBER = "006208398723029951";
        
        let app;
        let db;
        let auth;
        let userId = null;
        let accountRef = null;
        let currentBalance = INITIAL_BALANCE;
        let transactionHistory = [];
        
        // --- HTML Element References ---
        const balanceEl = document.getElementById('balance');
        const historyTableBody = document.getElementById('history-table-body');
        const totalTransactionsEl = document.getElementById('total-transactions');
        const messageBox = document.getElementById('message-box');
        const messageText = document.getElementById('message-text');
        const loginContainer = document.getElementById('login-container');
        const dashboardContainer = document.getElementById('dashboard-container');
        const accountUserIdEl = document.getElementById('account-user-id');
        const accountHolderEl = document.getElementById('account-holder-name');
        
        // Transaction buttons for disabling during processing
        const depositBtn = document.getElementById('deposit-btn');
        const withdrawBtn = document.getElementById('withdraw-btn');
        const interestBtn = document.getElementById('interest-btn');
        const transferBtn = document.getElementById('transfer-btn');


        // --- Utility Functions ---

        /**
         * Disables/enables transaction buttons to prevent concurrent updates.
         * @param {boolean} disabled 
         */
        function setActionButtonsDisabled(disabled) {
            depositBtn && (depositBtn.disabled = disabled);
            withdrawBtn && (withdrawBtn.disabled = disabled);
            interestBtn && (interestBtn.disabled = disabled);
            transferBtn && (transferBtn.disabled = disabled);
        }

        /**
         * Shows a temporary message box for success or error feedback.
         */
        function showMessage(msg, type = 'success') {
            messageText.textContent = msg;
            messageBox.className = `fixed top-4 right-4 p-4 rounded-lg z-50 transition-transform transform ${type === 'success' ? 'bg-green-100 text-green-800' : 'bg-red-100 text-red-800'} shadow-lg translate-x-0`;
            setTimeout(() => {
                messageBox.className = `fixed top-4 right-4 p-4 rounded-lg z-50 transition-transform transform translate-x-full`;
            }, 3000);
        }

        /**
         * Formats a number as a currency string.
         */
        const formatCurrency = (amount) => {
            return new Intl.NumberFormat('en-US', {
                style: 'currency',
                currency: 'USD',
                minimumFractionDigits: 2,
            }).format(amount);
        };

        /**
         * Generates a unique, short transaction reference ID.
         */
        const generateRefId = (type) => {
            const prefix = type === 'Debit' ? 'TRXD' : 'TRXC';
            return prefix + Math.random().toString(16).substring(2, 10).toUpperCase();
        };

        /**
         * Calculates the daily interest for a Fixed Deposit Account.
         */
        const calculateDailyInterest = (balance) => {
            const APR = 0.0425; // 4.25% Annual Percentage Rate
            const DAILY_RATE = APR / 365;
            const interest = balance * DAILY_RATE;
            // Round to 2 decimal places for currency
            return Math.round(interest * 100) / 100;
        };

        // --- Core Application Logic ---

        /**
         * Renders the current balance and transaction history.
         */
        function renderDashboard() {
            balanceEl.textContent = formatCurrency(currentBalance);
            accountHolderEl.textContent = ACCOUNT_HOLDER_NAME;
            totalTransactionsEl.textContent = transactionHistory.length;
            
            // Render History
            historyTableBody.innerHTML = '';
            // Only render last 10 transactions
            transactionHistory.slice(-10).reverse().forEach((tx, index) => { 
                const row = historyTableBody.insertRow();
                row.className = index % 2 === 0 ? 'bg-gray-50' : 'bg-white';
                
                // Determine if timestamp is a Firestore Timestamp object or a JS Date
                let displayDate = 'N/A';
                if (tx.timestamp) {
                    // Check if the timestamp is a Firestore Timestamp object with a toDate method
                    const dateObj = typeof tx.timestamp.toDate === 'function' ? tx.timestamp.toDate() : new Date(tx.timestamp);
                    displayDate = dateObj.toLocaleDateString();
                }

                // Index
                const cellIndex = row.insertCell();
                cellIndex.textContent = transactionHistory.length - (transactionHistory.length - index - 1);
                cellIndex.className = 'py-2 px-4 text-gray-500';

                // Reference
                const cellRef = row.insertCell();
                cellRef.textContent = tx.refId;
                cellRef.className = 'py-2 px-4 font-mono text-xs text-gray-700';

                // Amount
                const cellAmount = row.insertCell();
                cellAmount.textContent = formatCurrency(tx.amount);
                cellAmount.className = `py-2 px-4 font-semibold ${tx.type === 'Credit' ? 'text-green-600' : 'text-red-600'}`;

                // Type
                const cellType = row.insertCell();
                cellType.textContent = tx.type;
                cellType.className = `py-2 px-4 font-medium ${tx.type === 'Credit' ? 'text-green-700' : 'text-red-700'}`;

                // Date
                const cellDate = row.insertCell();
                cellDate.textContent = displayDate;
                cellDate.className = 'py-2 px-4 text-gray-500 text-sm';

                // Balance
                const cellBalance = row.insertCell();
                cellBalance.textContent = formatCurrency(tx.runningBalance);
                cellBalance.className = 'py-2 px-4 font-medium text-gray-800';
            });
        }

        /**
         * Creates a new account document in Firestore if one does not exist.
         */
        async function initializeAccount() {
            accountRef = doc(db, 'artifacts', appId, 'users', userId, 'accountData', 'main');

            try {
                const docSnap = await getDoc(accountRef);

                if (!docSnap.exists()) {
                    // Seed the transaction history for a new account
                    const seededHistory = [
                        { refId: 'TRXD96E73C7', type: 'Debit', amount: 950.00, timestamp: new Date(Date.now() - 8 * 86400000), runningBalance: 40799032.65 },
                        { refId: 'TRXCA9F71F16', type: 'Credit', amount: 10200950.00, timestamp: new Date(Date.now() - 7 * 86400000), runningBalance: 50999982.65 },
                        { refId: 'TRXD093AEE8D', type: 'Debit', amount: 950.00, timestamp: new Date(Date.now() - 6 * 86400000), runningBalance: 50999032.65 },
                        { refId: 'TRXC8FE0A45D', type: 'Credit', amount: 10200950.00, timestamp: new Date(Date.now() - 5 * 86400000), runningBalance: 61199982.65 },
                        { refId: 'TRXD749FFDD2', type: 'Debit', amount: 950.00, timestamp: new Date(Date.now() - 4 * 86400000), runningBalance: 61199032.65 },
                        { refId: 'TRXC9DE8249B', type: 'Credit', amount: 10200950.00, timestamp: new Date(Date.now() - 3 * 86400000), runningBalance: 71399982.65 },
                        { refId: 'TRXDAD68D66D', type: 'Debit', amount: 950.00, timestamp: new Date(Date.now() - 2 * 86400000), runningBalance: 71399032.65 },
                        { refId: 'TRXCC5B2F62F', type: 'Credit', amount: 400000.00, timestamp: new Date(Date.now() - 1 * 86400000), runningBalance: 71799032.65 },
                        { refId: 'TRXCC5B2162F', type: 'Credit', amount: 0.00, timestamp: new Date(), runningBalance: 71799032.65 },
                    ];

                    const data = {
                        balance: INITIAL_BALANCE,
                        accountHolder: ACCOUNT_HOLDER_NAME,
                        history: seededHistory,
                        createdAt: new Date(),
                    };
                    await setDoc(accountRef, data);
                    showMessage("New account created and seeded with starting balance.", 'success');
                } else {
                    // This check is good practice to ensure the sandbox initial state is correct
                    const data = docSnap.data();
                    if (data.accountHolder !== ACCOUNT_HOLDER_NAME) {
                           await updateDoc(accountRef, {
                                accountHolder
